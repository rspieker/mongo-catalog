name: Recipe

on:
    push:
    schedule:
        - cron: '0 7 * * 0/3'
    workflow_dispatch:

jobs:
    setup:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20.x
                  cache: 'npm'

            - name: install
              run: npm install

            - name: Update Mongo Versions
              run: npm run update:mongo-versions

            - name: Update Catalog Queries
              run: npm run update:catalog-queries

            - name: Create base patch
              run: |
                  git config user.name "GitHub Actions Recipe Bot"
                  git config user.email "<>"
                  git add ./automation/
                  git diff --cached > /tmp/setup.patch

            - name: Upload base patch
              uses: actions/upload-artifact@v4
              with:
                  name: patch-setup
                  path: /tmp/setup.patch

    workload:
        runs-on: ubuntu-latest
        needs: setup

        outputs:
            work: ${{ steps.capture.outputs.captured }}

        steps:
            - uses: actions/checkout@v4

            - name: Download base patch
              uses: actions/download-artifact@v4
              with:
                  name: patch-setup
                  path: /tmp/

            - name: Apply and commit setup patch
              run: |
                  git apply /tmp/setup.patch
                  git add ./automation/
                  git commit -m "Apply setup state"

            - name: Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20.x
                  cache: 'npm'

            - name: install
              run: npm install

            - name: Determine Workload
              id: capture
              run: echo "captured=$(npm run --silent update:workload)" >> "$GITHUB_OUTPUT"

            - name: Create workload patch
              run: |
                  git config user.name "GitHub Actions Recipe Bot"
                  git config user.email "<>"
                  # Create patch with only workload changes
                  git diff ./automation/ > /tmp/workload.patch

            - name: Upload workload patch
              uses: actions/upload-artifact@v4
              with:
                  name: patch-workload
                  path: /tmp/workload.patch

    collect-versions:
        runs-on: ubuntu-latest
        needs: workload

        strategy:
            matrix:
                version: ${{ fromJSON(needs.workload.outputs.work )}}

        env:
            MONGO_VERSION: ${{ matrix.version }}

        steps:
            - uses: actions/checkout@v4

            - name: Download patches
              uses: actions/download-artifact@v4
              with:
                  path: /tmp/patches/
                  pattern: 'patch-*'

            - name: Apply workload patch
              run: |
                  git apply /tmp/patches/patch-setup/setup.patch
                  git apply /tmp/patches/patch-workload/workload.patch
                  git add ./automation/
                  git commit -m "Apply workload state" || true

            - name: Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20.x
                  cache: 'npm'

            - name: install
              run: npm install

            - name: Start MongoDB
              uses: supercharge/mongodb-github-action@1.7.0
              with:
                  mongodb-version: ${{ matrix.version }}

            - run: npm run update:mongo-collect

            - name: Create patch
              run: |
                  git config user.name "GitHub Actions Recipe Bot"
                  git config user.email "<>"
                  # Create patch with only changes from mongo-collect (unstaged changes)
                  git diff ./automation/ > /tmp/changes-${{ matrix.version }}.patch

            - name: Upload patch
              uses: actions/upload-artifact@v4
              with:
                  name: patch-${{ matrix.version }}
                  path: /tmp/changes-${{ matrix.version }}.patch

    commit-results:
        runs-on: ubuntu-latest
        needs: collect-versions

        steps:
            - uses: actions/checkout@v4

            - name: Download patches
              uses: actions/download-artifact@v4
              with:
                  path: /tmp/patches/
                  pattern: 'patch-*'

            - name: Apply all patches
              run: |
                  git config user.name "GitHub Actions Recipe Bot"
                  git config user.email "<>"

                  # Apply workload patch (contains setup + plan.json)
                  git apply /tmp/patches/patch-workload/workload.patch

                  # Apply version patches (only specific version changes)
                  for patch_dir in /tmp/patches/patch-*/; do
                    patch_file=$(find "$patch_dir" -name "changes-*.patch" -type f 2>/dev/null | head -1)
                    if [ -n "$patch_file" ]; then
                      echo "Applying $(basename $patch_file)"
                      git apply "$patch_file"
                    fi
                  done

            - name: Commit results
              run: |
                  git add ./automation/
                  git diff --cached --quiet || (git commit -m "Update catalog results $(date +"%Y-%m-%dT%H:%M:%S%z")" && git push origin main)
