name: Recipe

on:
    push:
    schedule:
        # - cron: '0 7 * * 0/3'
        - cron: '0 */2 * * *'
    workflow_dispatch:

jobs:
    setup:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20.x
                  cache: 'npm'

            - name: install
              run: npm install

            - name: Update Mongo Versions
              run: npm run update:mongo-versions

            - name: Update Catalog Queries
              run: npm run update:catalog-queries

            - name: Upload initial state
              uses: actions/upload-artifact@v4
              with:
                  name: mongo-state
                  path: ./automation/
                  retention-days: 1

    workload:
        runs-on: ubuntu-latest
        needs: setup

        outputs:
            work: ${{ steps.capture.outputs.captured }}

        steps:
            - uses: actions/checkout@v4

            - name: Download state
              uses: actions/download-artifact@v4
              with:
                  name: mongo-state
                  path: ./automation/

            - name: Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20.x
                  cache: 'npm'

            - name: install
              run: npm install

            - name: Determine Workload
              id: capture
              run: |
                  WORKLOAD_OUTPUT=$(npm run --silent update:workload)
                  # Extract just the versions array from the JSON output
                  VERSIONS=$(echo "$WORKLOAD_OUTPUT" | jq -c '.versions')
                  echo "captured=$VERSIONS" >> "$GITHUB_OUTPUT"

            - name: Upload updated state
              uses: actions/upload-artifact@v4
              with:
                  name: mongo-state
                  path: ./automation/
                  retention-days: 1
                  overwrite: true

    collect-versions:
        runs-on: ubuntu-latest
        needs: workload

        strategy:
            fail-fast: false
            matrix:
                version: ${{ fromJSON(needs.workload.outputs.work )}}

        env:
            MONGO_VERSION: ${{ matrix.version }}

        steps:
            - uses: actions/checkout@v4

            - name: Download state
              uses: actions/download-artifact@v4
              with:
                  name: mongo-state
                  path: ./automation/

            - name: Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20.x
                  cache: 'npm'

            - name: Get Docker tag
              id: docker
              run: |
                  VERSION="${{ matrix.version }}"
                  MAJOR=$(echo "$VERSION" | cut -d. -f1)
                  DOCKER_TAG=$(jq -r '.name' "./automation/collect/v${MAJOR}/${VERSION}/plan.json")
                  echo "tag=$DOCKER_TAG" >> "$GITHUB_OUTPUT"

            - name: Start MongoDB
              id: mongodb
              run: |
                  VERSION="${{ matrix.version }}"
                  DOCKER_TAG="${{ steps.docker.outputs.tag }}"

                  # Start MongoDB container in background
                  docker run -d \
                    --name mongodb-$VERSION \
                    -p 27017:27017 \
                    --health-cmd="mongo --eval 'quit(0)' || mongosh --eval 'quit(0)' || exit 1" \
                    --health-interval=10s \
                    --health-timeout=5s \
                    --health-retries=5 \
                    mongo:$DOCKER_TAG

                  # Wait for healthy
                  echo "Waiting for MongoDB to be healthy..."
                  for i in {1..60}; do
                    HEALTH=$(docker inspect --format='{{.State.Health.Status}}' mongodb-$VERSION 2>/dev/null || echo "starting")
                    if [ "$HEALTH" = "healthy" ]; then
                      echo "MongoDB is healthy!"
                      break
                    fi
                    echo "Status: $HEALTH (attempt $i/60)"
                    sleep 2
                  done

                  if [ "$HEALTH" != "healthy" ]; then
                    echo "MongoDB failed to become healthy"
                    docker logs mongodb-$VERSION
                    exit 1
                  fi

            - name: Install dependencies
              id: install
              run: npm install

            - name: Run collection
              id: collect
              run: npm run update:mongo-collect

            - name: Mark version as skipped on failure
              if: failure()
              run: |
                  VERSION="${{ matrix.version }}"
                  MAJOR=$(echo "$VERSION" | cut -d. -f1)
                  META_FILE="./automation/collect/v${MAJOR}/${VERSION}/meta.json"
                  
                  # Determine failure reason based on which step failed
                  FAILURE_REASON="unknown"
                  if [ "${{ steps.docker.outcome }}" == "failure" ]; then
                    FAILURE_REASON="docker-tag-resolution-failed"
                  elif [ "${{ steps.mongodb.outcome }}" == "failure" ]; then
                    FAILURE_REASON="mongodb-start-failed"
                  elif [ "${{ steps.install.outcome }}" == "failure" ]; then
                    FAILURE_REASON="npm-install-failed"
                  elif [ "${{ steps.collect.outcome }}" == "failure" ]; then
                    FAILURE_REASON="catalog-execution-failed"
                  fi
                  
                  echo "Marking $VERSION as skipped due to: $FAILURE_REASON"
                  
                  # Update meta.json with skip flag and history entry
                  NOW=$(date -u +"%Y-%m-%dT%H:%M:%S.%3NZ")
                  jq --arg reason "$FAILURE_REASON" --arg date "$NOW" '
                    .skip = true |
                    .history = (.history // []) + [{
                      "type": "SKIP",
                      "date": $date,
                      "actions": [{
                        "type": "SKIP",
                        "reason": $reason,
                        "date": $date
                      }]
                    }]
                  ' "$META_FILE" > "$META_FILE.tmp" && mv "$META_FILE.tmp" "$META_FILE"
                  
                  # Stage the modified meta.json for commit
                  mkdir -p "/tmp/mongo-catalog-changes/${VERSION}"
                  cp "$META_FILE" "/tmp/mongo-catalog-changes/${VERSION}/meta.json"

            - name: Cleanup MongoDB
              if: always()
              run: |
                  VERSION="${{ matrix.version }}"
                  docker stop mongodb-$VERSION 2>/dev/null || true
                  docker rm mongodb-$VERSION 2>/dev/null || true

            - name: Upload results
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: results-${{ matrix.version }}
                  path: /tmp/mongo-catalog-changes
                  retention-days: 1

    commit-results:
        runs-on: ubuntu-latest
        needs: collect-versions

        steps:
            - uses: actions/checkout@v4

            - name: Download base state
              uses: actions/download-artifact@v4
              with:
                  name: mongo-state
                  path: ./automation/

            - name: Download results
              uses: actions/download-artifact@v4
              with:
                  path: /tmp/results/
                  pattern: 'results-*'
                  merge-multiple: false

            - name: Merge version-specific results
              run: |
                  for artifact_dir in /tmp/results/results-*/; do
                    if [ -d "$artifact_dir" ]; then
                      # artifact_dir contains something like: 5.0.32/
                      for version_dir in "$artifact_dir"*/; do
                        if [ -d "$version_dir" ]; then
                          version_name=$(basename "$version_dir")
                          major_version="v${version_name%%.*}"

                          echo "Copying $version_name to automation/collect/$major_version/"
                          mkdir -p "./automation/collect/$major_version"
                          cp -r "$version_dir" "./automation/collect/$major_version/"
                        fi
                      done
                    fi
                  done

            - name: Commit results
              run: |
                  git config user.name "GitHub Actions Recipe Bot"
                  git config user.email "<>"
                  git add ./automation/
                  git diff --cached --quiet || (git commit -m "Update catalog results $(date +"%Y-%m-%dT%H:%M:%S%z")" && git push origin main)
